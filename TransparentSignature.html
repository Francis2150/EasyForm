<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Signature Crop & Background Remover</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
  <style>
    body { font-family: sans-serif; padding: 20px; }
    img { max-width: 100%; }
    canvas { border: 1px solid #444; margin-top: 10px; max-width: 100%; display: block; }
    button { margin: 8px 5px 0 0; padding: 8px 14px; font-size: 14px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Signature Crop & Background Remover</h2>
  <input type="file" id="upload" accept="image/*"><br><br>
  
  <div>
    <img id="image" style="max-width:100%; display:none;">
  </div>
  
  <button id="cropBtn" style="display:none;">Crop & Remove Background</button>
  <canvas id="canvas"></canvas>
  <button id="download" style="display:none;">Download Transparent PNG</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script>
    let cropper;
    const upload = document.getElementById("upload");
    const image = document.getElementById("image");
    const cropBtn = document.getElementById("cropBtn");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const downloadBtn = document.getElementById("download");

    // Step 1: Upload and show cropper
    upload.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      image.src = url;
      image.style.display = "block";

      if (cropper) cropper.destroy();
      cropper = new Cropper(image, {
        aspectRatio: NaN, // free aspect ratio
        viewMode: 1
      });
      cropBtn.style.display = "inline-block";
    });

    // Step 2: Crop and remove background
    cropBtn.addEventListener("click", () => {
      const croppedCanvas = cropper.getCroppedCanvas();
      canvas.width = croppedCanvas.width;
      canvas.height = croppedCanvas.height;
      ctx.drawImage(croppedCanvas, 0, 0);

      let imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      let data = imgData.data;

      for (let i = 0; i < data.length; i += 4) {
        let r = data[i], g = data[i+1], b = data[i+2];
        // near-white removal
     // If the pixel is NOT dark (i.e., not ink), make it transparent
let brightness = 0.299 * r + 0.587 * g + 0.114 * b; // standard luminance formula
if (brightness > 180) { // You can adjust this threshold
  data[i+3] = 0; // make light pixels transparent
}

      }

      ctx.putImageData(imgData, 0, 0);
      downloadBtn.style.display = "inline-block";
    });

    // Step 3: Download PNG
    downloadBtn.addEventListener("click", () => {
      const link = document.createElement("a");
      link.download = "signature.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    });
  </script>
</body>
</html>