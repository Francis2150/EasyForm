<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Data Collection System</title>
    <link rel="stylesheet" href="data.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 id="mainTitle">Company Data Collection Form</h2>
                    <div>
                        <a href="index.html" class="btn btn-outline-primary">
                            <i class="fas fa-home me-2"></i>Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Client List View -->
        <div id="clientListView" style="display: none;">
            <div class="form-container">
                <div class="section-header">
                    <h3>Submitted Client Data</h3>
                    <button class="btn-add" onclick="showNewClientForm()">Add New Client</button>
                </div>
                <div id="clientListContainer" class="client-list">
                    <!-- Client entries will be dynamically added here -->
                </div>
            </div>
        </div>

        <!-- Form View -->
        <div id="formView">
            <div class="form-container">
                <form id="mainForm">

                    <!-- 1. Company Information -->
                    <fieldset id="companyInfo">
                        <legend>Company Information</legend>
                        <div class="form-group"><label>Company Name</label><input name="Company Name" required></div>
                    
                        <div class="form-group"><label>Presented By</label><input name="Presented By" required></div>
                        <div class="form-group"><label>Presenter TIN</label><input name="Presenter TIN" required></div>
                        <div class="form-group"><label>Activities</label><input name="Activities"></div>
                        <div class="form-group"><label>Stated Capital</label><input type="number" name="Stated Capital"></div>
                        <div class="form-group"><label>Estimated Revenue</label><input type="number" name="Estimated Revenue"></div>
                        <div class="form-group"><label>Number of Employees</label><input type="number" name="Number of Employees"></div>
                    </fieldset>

                    <!-- 2. Office Details -->
                    <fieldset id="officeDetails">
                        <legend>Office Details</legend>
                        <div class="form-group"><label>GPS Address</label><input name="GPS Address"></div>
                        <div class="form-group"><label>Landmark</label><input name="Landmark"></div>
                        <div class="form-group"><label>Building No.</label><input name="Building No."></div>
                        <div class="form-group"><label>Town</label><input name="Town"></div>
                        <div class="form-group"><label>Street Name</label><input name="Street Name"></div>
                        <div class="form-group"><label>City</label><input name="City"></div>
                        <div class="form-group"><label>District</label><input name="District"></div>
                        <div class="form-group"><label>Region</label><input name="Region"></div>

                        <div class="form-group"><label>Postal Number</label><input name="Postal Number"></div>
                        <div class="form-group"><label>Postal Town</label><input name="Postal Town"></div>
                        <div class="form-group"><label>Postal Region</label><input name="Postal Region"></div>
                        <div class="form-group"><label>Contact 1</label><input name="Contact 1"></div>
                        <div class="form-group"><label>Contact 2</label><input name="Contact 2"></div>
                        <div class="form-group"><label>Email</label><input name="Email" type="email"></div>
                    </fieldset>

                    <!-- 3. Directors -->
                    <fieldset id="directors">
                        <legend>Directors</legend>
                        <div id="directorsContainer">
                            <div class="dynamic-section">
                                <h4>Director 1</h4>
                                <div class="director-roles">
                                    <div class="checkbox-group">
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="isSubscriber" onchange="toggleSharePercent(this, 0)">
                                            <span>Is also a Subscriber</span>
                                        </label>
                                        <div class="share-percent-container" style="display: none;">
                                            <label>Share Percentage</label>
                                            <input type="number" name="sharePercent" min="0" max="100" step="0.01">
                                        </div>
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="isSecretary" onchange="handleSecretarySelection(this, 0)">
                                            <span>Is also the Secretary</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="two-column">
                                    <div class="form-group"><label>First Name</label><input name="First Name"></div>
                                    <div class="form-group"><label>Middle Name</label><input name="Middle Name"></div>
                                </div>
                                <div class="two-column">
                                    <div class="form-group"><label>Surname</label><input name="Surname"></div>
                                    <div class="form-group"><label>Former Name</label><input name="Former Name"></div>
                                </div>
                                <div class="two-column">
                                    <div class="form-group"><label>Date of Birth</label><input name="Date of Birth" type="text"></div>
                                    <div class="form-group"><label>Place of Birth</label><input name="Place of Birth"></div>
                                </div>
                                <div class="two-column">
                                    <div class="form-group"><label>Nationality</label><input name="Nationality" type="text"></div>
                                    <div class="form-group"><label>Occupation</label><input name="Occupation"></div>
                                </div>
                                <div class="two-column">
                                    <div class="form-group"><label>Contact 1</label><input name="Contact 1"></div>
                                    <div class="form-group"><label>Contact 2</label><input name="Contact 2"></div>
                                </div>
                                <div class="form-group"><label>Email</label><input name="Email" type="email"></div>
                                <div class="two-column">
                                    <div class="form-group"><label>TIN</label><input name="TIN"></div>
                                    <div class="form-group"><label>Ghana Card</label><input name="Ghana Card"></div>
                                </div>
                                <div class="address-group">
                                    <h5>Residential Address</h5>
                                    <div class="two-column">
                                        <div class="form-group"><label>GPS</label><input name="GPS"></div>
                                        <div class="form-group"><label>House No.</label><input name="House No."></div>
                                    </div>
                                    <div class="form-group"><label>Landmark</label><input name="Landmark"></div>
                                    <div class="form-group"><label>Street</label><input name="Street"></div>
                                    <div class="two-column">
                                        <div class="form-group"><label>City</label><input name="City"></div>
                                        <div class="form-group"><label>Town</label><input name="Town"></div>
                                    </div>
                                    <div class="two-column">
                                        <div class="form-group"><label>District</label><input name="District"></div>
                                        <div class="form-group"><label>Region</label><input name="Region"></div>
                                    </div>
                                    <div class="form-group"><label>Country</label><input name="Country"></div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn-add" onclick="addDirector()">Add Director</button>
                    </fieldset>

                    <!-- 4. Secretary Details -->
                    <fieldset id="secretaryDetails">
                        <legend>Secretary Details</legend>
                        <div class="form-group"><label>Qualification</label><input name="Qualification"></div>
                        <div class="two-column">
                            <div class="form-group"><label>First Name</label><input name="First Name"></div>
                            <div class="form-group"><label>Middle Name</label><input name="Middle Name"></div>
                        </div>
                        <div class="two-column">
                            <div class="form-group"><label>Surname</label><input name="Surname"></div>
                            <div class="form-group"><label>Former Name</label><input name="Former Name"></div>
                        </div>
                        <div class="two-column">
                            <div class="form-group"><label>Date of Birth</label><input name="Date of Birth" type="text"></div>
                            <div class="form-group"><label>Place of Birth</label><input name="Place of Birth"></div>
                        </div>
                        <div class="two-column">
                            <div class="form-group"><label>Nationality</label><input name="Nationality" type="text"></div>
                            <div class="form-group"><label>Occupation</label><input name="Occupation"></div>
                        </div>
                        <div class="two-column">
                            <div class="form-group"><label>Contact 1</label><input name="Contact 1"></div>
                            <div class="form-group"><label>Contact 2</label><input name="Contact 2"></div>
                        </div>
                        <div class="form-group"><label>Email</label><input name="Email" type="email"></div>
                        <div class="two-column">
                            <div class="form-group"><label>TIN</label><input name="TIN"></div>
                            <div class="form-group"><label>Ghana Card</label><input name="Ghana Card"></div>
                        </div>
                        <div class="address-group">
                            <h5>Residential Address</h5>
                            <div class="two-column">
                                <div class="form-group"><label>GPS</label><input name="GPS"></div>
                                <div class="form-group"><label>House No.</label><input name="House No."></div>
                            </div>
                            <div class="form-group"><label>Landmark</label><input name="Landmark"></div>
                            <div class="form-group"><label>Street</label><input name="Street"></div>
                            <div class="two-column">
                                <div class="form-group"><label>City</label><input name="City"></div>
                                <div class="form-group"><label>Town</label><input name="Town"></div>
                            </div>
                            <div class="two-column">
                                <div class="form-group"><label>District</label><input name="District"></div>
                                <div class="form-group"><label>Region</label><input name="Region"></div>
                            </div>
                            <div class="form-group"><label>Country</label><input name="Country"></div>
                        </div>
                    </fieldset>

                    <!-- 5. Subscribers -->
                    <fieldset id="subscribers">
                        <legend>Subscribers</legend>
                        <div id="subscribersContainer">
                            <div class="dynamic-section">
                                <h4>Subscriber 1</h4>
                                <div class="two-column">
                                    <div class="form-group"><label>First Name</label><input name="First Name"></div>
                                    <div class="form-group"><label>Middle Name</label><input name="Middle Name"></div>
                                </div>
                                <div class="two-column">
                                    <div class="form-group"><label>Surname</label><input name="Surname"></div>
                                    <div class="form-group"><label>Former Name</label><input name="Former Name"></div>
                                </div>
                                <div class="two-column">
                                    <div class="form-group"><label>Date of Birth</label><input name="Date of Birth" type="text"></div>
                                    <div class="form-group"><label>Place of Birth</label><input name="Place of Birth"></div>
                                </div>
                                <div class="two-column">
                                    <div class="form-group"><label>Nationality</label><input name="Nationality" type="text"></div>
                                    <div class="form-group"><label>Occupation</label><input name="Occupation"></div>
                                </div>
                                <div class="two-column">
                                    <div class="form-group"><label>Contact 1</label><input name="Contact 1"></div>
                                    <div class="form-group"><label>Contact 2</label><input name="Contact 2"></div>
                                </div>
                                <div class="form-group"><label>Email</label><input name="Email" type="email"></div>
                                <div class="two-column">
                                    <div class="form-group"><label>TIN</label><input name="TIN"></div>
                                    <div class="form-group"><label>Ghana Card</label><input name="Ghana Card"></div>
                                </div>
                                <div class="address-group">
                                    <h5>Residential Address</h5>
                                    <div class="two-column">
                                        <div class="form-group"><label>GPS</label><input name="GPS"></div>
                                        <div class="form-group"><label>House No.</label><input name="House No."></div>
                                    </div>
                                    <div class="form-group"><label>Landmark</label><input name="Landmark"></div>
                                    <div class="form-group"><label>Street</label><input name="Street"></div>
                                    <div class="two-column">
                                        <div class="form-group"><label>City</label><input name="City"></div>
                                        <div class="form-group"><label>Town</label><input name="Town"></div>
                                    </div>
                                    <div class="two-column">
                                        <div class="form-group"><label>District</label><input name="District"></div>
                                        <div class="form-group"><label>Region</label><input name="Region"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn-add" onclick="addSubscriber()">Add Subscriber</button>
                    </fieldset>

                    <button type="submit">Submit Form</button>
                </form>
            </div>
        </div>

        <!-- Client Detail View -->
        <div id="clientDetailView" style="display: none;">
            <div class="form-container">
                <div class="section-header">
                    <button class="btn-cancel" onclick="showClientList()">← Back to Client List</button>
                    <h3 id="clientDetailTitle">Client Data</h3>
                </div>
                <div id="clientDetailContainer">
                    <!-- Client data will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Notification element -->
    <div id="notification" class="notification"></div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Processing...</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBzSHkVxRiLC5gsq04LTTDnXaGdoF7eJ2c",
            authDomain: "easyregistrationforms.firebaseapp.com",
            projectId: "easyregistrationforms",
            storageBucket: "easyregistrationforms.firebasestorage.app",
            messagingSenderId: "589421628989",
            appId: "1:589421628989:web:d9f6e9dbe372ab7acd6454",
            measurementId: "G-GVCPBN8VB5"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global Variables
        let currentClientId = null;
        let selectedSecretaryIndex = -1; // Track which director is selected as secretary
        let dataCollectionLink = null;
        let userUid = null;

        // Check if there's a valid data collection link in the URL
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const link = urlParams.get('link');
            
            if (link) {
                dataCollectionLink = link;
                // Find the user with this data collection link
                findUserByDataCollectionLink(link);
            } else {
                // No valid link, redirect to home
                window.location.href = 'index.html';
            }
        });

        function findUserByDataCollectionLink(link) {
            showLoading(true);
            
            // Query users collection to find the user with this data collection link
            db.collection('users').where('dataCollectionLink', '==', link).get()
                .then((querySnapshot) => {
                    showLoading(false);
                    
                    if (querySnapshot.empty) {
                        showNotification('Invalid data collection link!', 'error');
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 3000);
                        return;
                    }
                    
                    // Get the user document
                    const userDoc = querySnapshot.docs[0];
                    userUid = userDoc.id;
                    const userData = userDoc.data();
                    
                    // Update the title with the user's name
                    document.getElementById('mainTitle').textContent = `${userData.firstName}'s Company Data Collection Form`;
                    
                    // Load existing client data
                    loadClientData();
                })
                .catch((error) => {
                    showLoading(false);
                    console.error('Error finding user:', error);
                    showNotification('Error validating data collection link!', 'error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 3000);
                });
        }

        function loadClientData() {
            // Check if there are existing clients
            const clients = getClientsFromStorage();
            if (clients.length > 0) {
                showClientList();
            }
        }

        function getClientsFromStorage() {
            const clients = localStorage.getItem(`clientData_${userUid}`);
            return clients ? JSON.parse(clients) : [];
        }

        function saveClientToStorage(clientData) {
            const clients = getClientsFromStorage();
            clients.push(clientData);
            localStorage.setItem(`clientData_${userUid}`, JSON.stringify(clients));
            
            // Also save to Firestore for persistence across devices
            db.collection('users').doc(userUid).update({
                clientData: firebase.firestore.FieldValue.arrayUnion(clientData)
            }).catch(error => {
                console.error('Error saving client data to Firestore:', error);
            });
        }

        function deleteClientFromStorage(clientId) {
            const clients = getClientsFromStorage();
            const filteredClients = clients.filter(client => client.id !== clientId);
            localStorage.setItem(`clientData_${userUid}`, JSON.stringify(filteredClients));
            
            // Also update Firestore
            db.collection('users').doc(userUid).update({
                clientData: filteredClients
            }).catch(error => {
                console.error('Error updating client data in Firestore:', error);
            });
        }

        function generateClientId() {
            return 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function showClientList() {
            document.getElementById('formView').style.display = 'none';
            document.getElementById('clientDetailView').style.display = 'none';
            document.getElementById('clientListView').style.display = 'block';
            
            renderClientList();
        }

        function showNewClientForm() {
            document.getElementById('clientListView').style.display = 'none';
            document.getElementById('clientDetailView').style.display = 'none';
            document.getElementById('formView').style.display = 'block';
            document.getElementById('mainForm').reset();
            
            // Reset secretary selection
            selectedSecretaryIndex = -1;
            document.getElementById('secretaryDetails').style.display = 'block';
        }

        function renderClientList() {
            const container = document.getElementById('clientListContainer');
            const clients = getClientsFromStorage();
            
            if (clients.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No Client Data Found</h3>
                        <p>Click "Add New Client" to start collecting data</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = clients.map(client => {
                const companyName = client.formData.find(field => field.label === 'Company Name')?.value || 'Unknown Company';
                const submittedDate = new Date(client.submittedAt).toLocaleString();
                
                return `
                    <div class="client-item">
                        <h4>${companyName}</h4>
                        <p><strong>Submitted:</strong> ${submittedDate}</p>
                        <p><strong>Directors:</strong> ${client.directors?.length || 0}</p>
                        <p><strong>Subscribers:</strong> ${client.subscribers?.length || 0}</p>
                        <div class="client-meta">
                            <span class="client-id">ID: ${client.id}</span>
                            <div>
                                <button class="btn-view" onclick="viewClient('${client.id}')">View Details</button>
                                <button class="btn-delete" onclick="deleteClient('${client.id}')">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewClient(clientId) {
            const clients = getClientsFromStorage();
            const client = clients.find(c => c.id === clientId);
            
            if (!client) {
                showNotification('Client not found!');
                return;
            }
            
            currentClientId = clientId;
            
            document.getElementById('formView').style.display = 'none';
            document.getElementById('clientListView').style.display = 'none';
            document.getElementById('clientDetailView').style.display = 'block';
            
            const companyName = client.formData.find(field => field.label === 'Company Name')?.value || 'Unknown Company';
            document.getElementById('clientDetailTitle').textContent = `${companyName} - Submitted ${new Date(client.submittedAt).toLocaleString()}`;
            
            renderClientDetail(client);
        }

        function renderClientDetail(client) {
            const container = document.getElementById('clientDetailContainer');
            container.innerHTML = '';
            
            // Render Business Information (Combined Company and Office Details)
            const businessFields = client.formData.filter(field => 
                field.section === 'companyInfo' || field.section === 'officeDetails'
            );
            
            if (businessFields.length > 0) {
                let html = `<div class="section-container">
                    <h3>Business Information</h3>
                    <table>
                        <tr><th>Field Label</th><th>Submitted Data</th></tr>`;
                
                businessFields.forEach(field => {
                    html += `<tr data-field="${field.label}">
                        <td>${field.label}</td>
                        <td class="value-cell">${field.value}</td>
                    </tr>`;
                });
                
                html += `</table>
                    <div class="button-group">
                        <button class="btn-edit" onclick="editSection('business')">Edit Section</button>
                        <button class="btn-save" style="display:none;" onclick="saveSection('business')">Save Section</button>
                        <button class="btn-cancel" style="display:none;" onclick="cancelEdit('business')">Cancel</button>
                        <button class="btn-copy" onclick="copySection('business')">Copy Section</button>
                    </div>
                </div>`;
                
                const sectionDiv = document.createElement('div');
                sectionDiv.innerHTML = html;
                sectionDiv.id = 'business-section';
                container.appendChild(sectionDiv);
            }
            
            // Check if any director is selected as secretary
            let hasDirectorAsSecretary = false;
            if (client.directorRoles) {
                for (let i = 0; i < client.directorRoles.length; i++) {
                    if (client.directorRoles[i] && client.directorRoles[i].isSecretary) {
                        hasDirectorAsSecretary = true;
                        break;
                    }
                }
            }
            
            // Render Directors
            if (client.directors && client.directors.length > 0) {
                client.directors.forEach((director, index) => {
                    // Create director role display
                    let roleHtml = '';
                    if (client.directorRoles && client.directorRoles[index]) {
                        const role = client.directorRoles[index];
                        let badges = [];
                        
                        if (role.isSubscriber) {
                            badges.push('<span class="role-badge subscriber">Subscriber</span>');
                        }
                        if (role.isSecretary) {
                            badges.push('<span class="role-badge secretary">Secretary</span>');
                        }
                        
                        roleHtml = `
                            <div class="director-role-display">
                                <h3>
                                    Directors - Entry ${index + 1}
                                    ${badges.length > 0 ? `<div class="role-badges">${badges.join('')}</div>` : ''}
                                </h3>
                                ${role.isSubscriber && role.sharePercent ? 
                                    `<div class="share-percent-display"><strong>Share Percentage:</strong> ${role.sharePercent}%</div>` : ''}
                            </div>`;
                    }
                    
                    let html = `<div class="section-container">
                        ${roleHtml}
                        <table>
                            <tr><th>Field Label</th><th>Submitted Data</th></tr>`;
                    
                    // Filter out role-related fields from the table
                    const filteredDirectorData = director.filter(field => 
                        !['isSubscriber', 'isSecretary', 'sharePercent'].includes(field.label)
                    );
                    
                    filteredDirectorData.forEach(field => {
                        html += `<tr data-field="${field.label}">
                            <td>${field.label}</td>
                            <td class="value-cell">${field.value}</td>
                        </tr>`;
                    });
                    
                    html += `</table>
                        <div class="button-group">
                            <button class="btn-edit" onclick="editSection('director-${index}')">Edit Section</button>
                            <button class="btn-save" style="display:none;" onclick="saveSection('director-${index}')">Save Section</button>
                            <button class="btn-cancel" style="display:none;" onclick="cancelEdit('director-${index}')">Cancel</button>
                            <button class="btn-copy" onclick="copySection('director-${index}')">Copy Section</button>
                        </div>
                    </div>`;
                    
                    const sectionDiv = document.createElement('div');
                    sectionDiv.innerHTML = html;
                    sectionDiv.id = `director-${index}-section`;
                    container.appendChild(sectionDiv);
                });
            }
            
            // Render Secretary only if no director is selected as secretary
            if (!hasDirectorAsSecretary && client.secretary && client.secretary.length > 0) {
                let html = `<div class="section-container">
                    <h3>Secretary Details</h3>
                    <table>
                        <tr><th>Field Label</th><th>Submitted Data</th></tr>`;
                
                client.secretary.forEach(field => {
                    html += `<tr data-field="${field.label}">
                        <td>${field.label}</td>
                        <td class="value-cell">${field.value}</td>
                    </tr>`;
                });
                
                html += `</table>
                    <div class="button-group">
                        <button class="btn-edit" onclick="editSection('secretary')">Edit Section</button>
                        <button class="btn-save" style="display:none;" onclick="saveSection('secretary')">Save Section</button>
                        <button class="btn-cancel" style="display:none;" onclick="cancelEdit('secretary')">Cancel</button>
                        <button class="btn-copy" onclick="copySection('secretary')">Copy Section</button>
                    </div>
                </div>`;
                
                const sectionDiv = document.createElement('div');
                sectionDiv.innerHTML = html;
                sectionDiv.id = 'secretary-section';
                container.appendChild(sectionDiv);
            }
            
            // Render Subscribers
            if (client.subscribers && client.subscribers.length > 0) {
                client.subscribers.forEach((subscriber, index) => {
                    let html = `<div class="section-container">
                        <h3>Subscribers - Entry ${index + 1}</h3>
                        <table>
                            <tr><th>Field Label</th><th>Submitted Data</th></tr>`;
                    
                    subscriber.forEach(field => {
                        html += `<tr data-field="${field.label}">
                            <td>${field.label}</td>
                            <td class="value-cell">${field.value}</td>
                        </tr>`;
                    });
                    
                    html += `</table>
                        <div class="button-group">
                            <button class="btn-edit" onclick="editSection('subscriber-${index}')">Edit Section</button>
                            <button class="btn-save" style="display:none;" onclick="saveSection('subscriber-${index}')">Save Section</button>
                            <button class="btn-cancel" style="display:none;" onclick="cancelEdit('subscriber-${index}')">Cancel</button>
                            <button class="btn-copy" onclick="copySection('subscriber-${index}')">Copy Section</button>
                        </div>
                    </div>`;
                    
                    const sectionDiv = document.createElement('div');
                    sectionDiv.innerHTML = html;
                    sectionDiv.id = `subscriber-${index}-section`;
                    container.appendChild(sectionDiv);
                });
            }
        }

        function deleteClient(clientId) {
            if (confirm('Are you sure you want to delete this client data?')) {
                deleteClientFromStorage(clientId);
                renderClientList();
                showNotification('Client data deleted successfully!');
            }
        }

        function editSection(sectionId) {
            const section = document.getElementById(sectionId + '-section');
            if (!section) return;
            
            const table = section.querySelector('table');
            const editBtn = section.querySelector('.btn-edit');
            const saveBtn = section.querySelector('.btn-save');
            const cancelBtn = section.querySelector('.btn-cancel');
            
            table.classList.add('edit-mode');
            editBtn.style.display = 'none';
            saveBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'inline-block';
            
            const rows = table.querySelectorAll('tr:not(:first-child)');
            rows.forEach(row => {
                const valueCell = row.querySelector('.value-cell');
                const currentValue = valueCell.textContent;
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentValue;
                input.className = 'edit-input';
                
                valueCell.innerHTML = '';
                valueCell.appendChild(input);
            });
        }

        function saveSection(sectionId) {
            const section = document.getElementById(sectionId + '-section');
            if (!section) return;
            
            const table = section.querySelector('table');
            const editBtn = section.querySelector('.btn-edit');
            const saveBtn = section.querySelector('.btn-save');
            const cancelBtn = section.querySelector('.btn-cancel');
            
            const rows = table.querySelectorAll('tr:not(:first-child)');
            const updatedData = [];
            
            rows.forEach(row => {
                const input = row.querySelector('.edit-input');
                const label = row.querySelector('td:first-child').textContent;
                const value = input ? input.value : row.querySelector('.value-cell').textContent;
                
                updatedData.push({ label, value });
                
                if (input) {
                    row.querySelector('.value-cell').textContent = value;
                }
            });
            
            // Update the client data in storage
            updateClientSectionData(sectionId, updatedData);
            
            table.classList.remove('edit-mode');
            editBtn.style.display = 'inline-block';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            
            showNotification('Section updated successfully!');
        }

        function cancelEdit(sectionId) {
            const section = document.getElementById(sectionId + '-section');
            if (!section) return;
            
            const table = section.querySelector('table');
            const editBtn = section.querySelector('.btn-edit');
            const saveBtn = section.querySelector('.btn-save');
            const cancelBtn = section.querySelector('.btn-cancel');
            
            table.classList.remove('edit-mode');
            editBtn.style.display = 'inline-block';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
        }

        function copySection(sectionId) {
            const section = document.getElementById(sectionId + '-section');
            if (!section) return;
            
            const rows = section.querySelectorAll('tr:not(:first-child)');
            const values = [];
            
            // Get all field labels to maintain order
            const fieldLabels = Array.from(rows).map(row => 
                row.querySelector('td:first-child').textContent
            );
            
            // Get all values (including empty ones)
            const fieldValues = Array.from(rows).map(row => 
                row.querySelector('.value-cell').textContent
            );
            
            // Create tab-separated values for spreadsheet compatibility
            const tabSeparatedValues = fieldValues.join('\t');
            
            // Copy to clipboard
            navigator.clipboard.writeText(tabSeparatedValues).then(() => {
                // Show notification about the format
                showCopyFormatNotification();
            });
        }

        function showCopyFormatNotification() {
            // Create notification element if it doesn't exist
            let notification = document.getElementById('copyFormatNotification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'copyFormatNotification';
                notification.className = 'copy-format-notification';
                document.body.appendChild(notification);
            }
            
            notification.innerHTML = `
                <h4>Data Copied!</h4>
                <p>Data has been copied as tab-separated values for spreadsheet compatibility.</p>
                <p>Empty fields are included to maintain cell positions when pasted.</p>
            `;
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function updateClientSectionData(sectionId, updatedData) {
            const clients = getClientsFromStorage();
            const clientIndex = clients.findIndex(c => c.id === currentClientId);
            
            if (clientIndex === -1) return;
            
            const client = clients[clientIndex];
            
            if (sectionId === 'business') {
                // Update business fields
                updatedData.forEach(field => {
                    const existingIndex = client.formData.findIndex(f => f.label === field.label);
                    if (existingIndex !== -1) {
                        client.formData[existingIndex].value = field.value;
                    }
                });
            } else if (sectionId.startsWith('director-')) {
                const index = parseInt(sectionId.split('-')[1]);
                if (client.directors && client.directors[index]) {
                    updatedData.forEach(field => {
                        const existingIndex = client.directors[index].findIndex(f => f.label === field.label);
                        if (existingIndex !== -1) {
                            client.directors[index][existingIndex].value = field.value;
                        }
                    });
                }
            } else if (sectionId === 'secretary') {
                if (client.secretary) {
                    updatedData.forEach(field => {
                        const existingIndex = client.secretary.findIndex(f => f.label === field.label);
                        if (existingIndex !== -1) {
                            client.secretary[existingIndex].value = field.value;
                        }
                    });
                }
            } else if (sectionId.startsWith('subscriber-')) {
                const index = parseInt(sectionId.split('-')[1]);
                if (client.subscribers && client.subscribers[index]) {
                    updatedData.forEach(field => {
                        const existingIndex = client.subscribers[index].findIndex(f => f.label === field.label);
                        if (existingIndex !== -1) {
                            client.subscribers[index][existingIndex].value = field.value;
                        }
                    });
                }
            }
            
            // Save updated client data
            clients[clientIndex] = client;
            localStorage.setItem(`clientData_${userUid}`, JSON.stringify(clients));
            
            // Also update Firestore
            db.collection('users').doc(userUid).update({
                clientData: clients
            }).catch(error => {
                console.error('Error updating client data in Firestore:', error);
            });
        }

        // Toggle Share Percentage input based on Subscriber checkbox
        function toggleSharePercent(checkbox, directorIndex) {
            const sharePercentContainer = checkbox.closest('.director-roles').querySelector('.share-percent-container');
            sharePercentContainer.style.display = checkbox.checked ? 'block' : 'none';
        }

        // Handle Secretary selection
        function handleSecretarySelection(checkbox, directorIndex) {
            if (checkbox.checked) {
                // Set this director as the secretary
                selectedSecretaryIndex = directorIndex;
                
                // Hide the Secretary Details fieldset
                document.getElementById('secretaryDetails').style.display = 'none';
                
                // Disable all other secretary checkboxes
                const allSecretaryCheckboxes = document.querySelectorAll('input[name="isSecretary"]');
                allSecretaryCheckboxes.forEach((cb, index) => {
                    if (index !== directorIndex) {
                        cb.checked = false;
                        cb.disabled = true;
                        cb.closest('.checkbox-label').classList.add('disabled');
                    }
                });
            } else {
                // Unset this director as secretary
                selectedSecretaryIndex = -1;
                
                // Show the Secretary Details fieldset
                document.getElementById('secretaryDetails').style.display = 'block';
                
                // Enable all secretary checkboxes
                const allSecretaryCheckboxes = document.querySelectorAll('input[name="isSecretary"]');
                allSecretaryCheckboxes.forEach(cb => {
                    cb.disabled = false;
                    cb.closest('.checkbox-label').classList.remove('disabled');
                });
            }
        }

        // Form submission handler
        document.getElementById('mainForm').addEventListener('submit', function(e){
            e.preventDefault();
            
            const clientId = generateClientId();
            const submittedAt = new Date().toISOString();
            
            // Collect all form data
            const formData = [];
            
            // Company Information
            const companyInfo = document.getElementById('companyInfo');
            companyInfo.querySelectorAll('input, select').forEach(inp => {
                formData.push({
                    label: inp.name,
                    value: inp.value.trim(),
                    section: 'companyInfo'
                });
            });
            
            // Office Details
            const officeDetails = document.getElementById('officeDetails');
            officeDetails.querySelectorAll('input, select').forEach(inp => {
                formData.push({
                    label: inp.name,
                    value: inp.value.trim(),
                    section: 'officeDetails'
                });
            });
            
            // Directors
            const directors = [];
            document.querySelectorAll('#directorsContainer .dynamic-section').forEach(section => {
                const directorData = [];
                section.querySelectorAll('input, select').forEach(inp => {
                    directorData.push({
                        label: inp.name,
                        value: inp.value.trim()
                    });
                });
                directors.push(directorData);
            });
            
            // Director Roles
            const directorRoles = [];
            document.querySelectorAll('#directorsContainer .dynamic-section').forEach((section, index) => {
                const isSubscriber = section.querySelector('input[name="isSubscriber"]').checked;
                const isSecretary = section.querySelector('input[name="isSecretary"]').checked;
                const sharePercent = isSubscriber ? section.querySelector('input[name="sharePercent"]').value : '';
                
                directorRoles.push({
                    isSubscriber: isSubscriber,
                    isSecretary: isSecretary,
                    sharePercent: sharePercent
                });
            });
            
            // Secretary - only collect if no director is selected as secretary
            let secretary = [];
            if (selectedSecretaryIndex === -1) {
                document.querySelectorAll('#secretaryDetails input, #secretaryDetails select').forEach(inp => {
                    secretary.push({
                        label: inp.name,
                        value: inp.value.trim()
                    });
                });
            }
            
            // Subscribers
            const subscribers = [];
            document.querySelectorAll('#subscribersContainer .dynamic-section').forEach(section => {
                const subscriberData = [];
                section.querySelectorAll('input, select').forEach(inp => {
                    subscriberData.push({
                        label: inp.name,
                        value: inp.value.trim()
                    });
                });
                subscribers.push(subscriberData);
            });
            
            // Create client data object
            const clientData = {
                id: clientId,
                submittedAt: submittedAt,
                formData: formData,
                directors: directors,
                directorRoles: directorRoles,
                secretary: secretary,
                subscribers: subscribers
            };
            
            // Save to storage
            saveClientToStorage(clientData);
            
            // Show success message and redirect to client list
            showNotification('Client data submitted successfully!');
            
            setTimeout(() => {
                showClientList();
            }, 1500);
        });

        // Dynamic section functions
        function addDirector() {
            const container = document.getElementById('directorsContainer');
            const currentCount = container.querySelectorAll('.dynamic-section').length;
            const newCount = currentCount + 1;
            
            // Add new director section with roles
            const newDirector = document.createElement('div');
            newDirector.className = 'dynamic-section';
            newDirector.innerHTML = `
                <button type="button" class="remove-btn" onclick="removeEntry(this, 'directors')">×</button>
                <h4>Director ${newCount}</h4>
                <div class="director-roles">
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="isSubscriber" onchange="toggleSharePercent(this, ${currentCount})">
                            <span>Is also a Subscriber</span>
                        </label>
                        <div class="share-percent-container" style="display: none;">
                            <label>Share Percentage</label>
                            <input type="number" name="sharePercent" min="0" max="100" step="0.01">
                        </div>
                        <label class="checkbox-label ${selectedSecretaryIndex !== -1 ? 'disabled' : ''}">
                            <input type="checkbox" name="isSecretary" onchange="handleSecretarySelection(this, ${currentCount})" ${selectedSecretaryIndex !== -1 ? 'disabled' : ''}>
                            <span>Is also the Secretary</span>
                        </label>
                    </div>
                </div>
                <div class="two-column">
                    <div class="form-group"><label>First Name</label><input name="First Name"></div>
                    <div class="form-group"><label>Middle Name</label><input name="Middle Name"></div>
                </div>
                <div class="two-column">
                    <div class="form-group"><label>Surname</label><input name="Surname"></div>
                    <div class="form-group"><label>Former Name</label><input name="Former Name"></div>
                </div>
                <div class="two-column">
                    <div class="form-group"><label>Date of Birth</label><input name="Date of Birth" type="text"></div>
                    <div class="form-group"><label>Place of Birth</label><input name="Place of Birth"></div>
                </div>
                <div class="two-column">
                    <div class="form-group"><label>Nationality</label><input name="Nationality" type="text"></div>
                    <div class="form-group"><label>Occupation</label><input name="Occupation"></div>
                </div>
                <div class="two-column">
                    <div class="form-group"><label>Contact 1</label><input name="Contact 1"></div>
                    <div class="form-group"><label>Contact 2</label><input name="Contact 2"></div>
                </div>
                <div class="form-group"><label>Email</label><input name="Email" type="email"></div>
                <div class="two-column">
                    <div class="form-group"><label>TIN</label><input name="TIN"></div>
                    <div class="form-group"><label>Ghana Card</label><input name="Ghana Card"></div>
                </div>
                <div class="address-group">
                    <h5>Residential Address</h5>
                    <div class="two-column">
                        <div class="form-group"><label>GPS</label><input name="GPS"></div>
                        <div class="form-group"><label>House No.</label><input name="House No."></div>
                    </div>
                    <div class="form-group"><label>Landmark</label><input name="Landmark"></div>
                    <div class="form-group"><label>Street</label><input name="Street"></div>
                    <div class="two-column">
                        <div class="form-group"><label>City</label><input name="City"></div>
                        <div class="form-group"><label>Town</label><input name="Town"></div>
                    </div>
                    <div class="two-column">
                        <div class="form-group"><label>District</label><input name="District"></div>
                        <div class="form-group"><label>Region</label><input name="Region"></div>
                    </div>
                    <div class="form-group"><label>Country</label><input name="Country"></div>
                </div>
            `;
            container.appendChild(newDirector);
        }

        function addSubscriber() {
            const container = document.getElementById('subscribersContainer');
            const currentCount = container.querySelectorAll('.dynamic-section').length;
            const newCount = currentCount + 1;
            
            const newSubscriber = document.createElement('div');
            newSubscriber.className = 'dynamic-section';
            newSubscriber.innerHTML = `
                <button type="button" class="remove-btn" onclick="removeEntry(this, 'subscribers')">×</button>
                <h4>Subscriber ${newCount}</h4>
                <div class="two-column">
                    <div class="form-group"><label>First Name</label><input name="First Name"></div>
                    <div class="form-group"><label>Middle Name</label><input name="Middle Name"></div>
                </div>
                <div class="two-column">
                    <div class="form-group"><label>Surname</label><input name="Surname"></div>
                    <div class="form-group"><label>Former Name</label><input name="Former Name"></div>
                </div>
                <div class="two-column">
                    <div class="form-group"><label>Date of Birth</label><input name="Date of Birth" type="text"></div>
                    <div class="form-group"><label>Place of Birth</label><input name="Place of Birth"></div>
                </div>
                <div class="two-column">
                    <div class="form-group"><label>Nationality</label><input name="Nationality" type="text"></div>
                    <div class="form-group"><label>Occupation</label><input name="Occupation"></div>
                </div>
                <div class="two-column">
                    <div class="form-group"><label>Contact 1</label><input name="Contact 1"></div>
                    <div class="form-group"><label>Contact 2</label><input name="Contact 2"></div>
                </div>
                <div class="form-group"><label>Email</label><input name="Email" type="email"></div>
                <div class="two-column">
                    <div class="form-group"><label>TIN</label><input name="TIN"></div>
                    <div class="form-group"><label>Ghana Card</label><input name="Ghana Card"></div>
                </div>
                <div class="address-group">
                    <h5>Residential Address</h5>
                    <div class="two-column">
                        <div class="form-group"><label>GPS</label><input name="GPS"></div>
                        <div class="form-group"><label>House No.</label><input name="House No."></div>
                    </div>
                    <div class="form-group"><label>Landmark</label><input name="Landmark"></div>
                    <div class="form-group"><label>Street</label><input name="Street"></div>
                    <div class="two-column">
                        <div class="form-group"><label>City</label><input name="City"></div>
                        <div class="form-group"><label>Town</label><input name="Town"></div>
                    </div>
                    <div class="two-column">
                        <div class="form-group"><label>District</label><input name="District"></div>
                        <div class="form-group"><label>Region</label><input name="Region"></div>
                    </div>
                </div>
            `;
            container.appendChild(newSubscriber);
        }

        function removeEntry(button, type) {
            const section = button.closest('.dynamic-section');
            const index = Array.from(section.parentNode.querySelectorAll('.dynamic-section')).indexOf(section);
            
            section.style.animation = 'fadeOut 0.3s ease-out';
            
            setTimeout(() => {
                section.remove();
                
                // Check if this director was selected as secretary
                if (type === 'directors') {
                    const secretaryCheckbox = section.querySelector('input[name="isSecretary"]');
                    if (secretaryCheckbox && secretaryCheckbox.checked) {
                        // Reset secretary selection
                        selectedSecretaryIndex = -1;
                        // Show secretary details section
                        document.getElementById('secretaryDetails').style.display = 'block';
                        // Enable all secretary checkboxes
                        const allSecretaryCheckboxes = document.querySelectorAll('input[name="isSecretary"]');
                        allSecretaryCheckboxes.forEach(cb => {
                            cb.disabled = false;
                            cb.closest('.checkbox-label').classList.remove('disabled');
                        });
                    }
                }
                
                // Renumber the remaining entries
                if (type === 'directors') {
                    updateDirectorNumbers();
                } else if (type === 'subscribers') {
                    updateSubscriberNumbers();
                }
            }, 300);
        }

        function updateDirectorNumbers() {
            const container = document.getElementById('directorsContainer');
            const directors = container.querySelectorAll('.dynamic-section');
            
            directors.forEach((director, index) => {
                const newNumber = index + 1;
                const h4 = director.querySelector('h4');
                if (h4) {
                    h4.textContent = `Director ${newNumber}`;
                }
                
                // Update the onchange handler for the subscriber checkbox
                const subscriberCheckbox = director.querySelector('input[name="isSubscriber"]');
                if (subscriberCheckbox) {
                    subscriberCheckbox.setAttribute('onchange', `toggleSharePercent(this, ${index})`);
                }
                
                // Update the onchange handler for the secretary checkbox
                const secretaryCheckbox = director.querySelector('input[name="isSecretary"]');
                if (secretaryCheckbox) {
                    secretaryCheckbox.setAttribute('onchange', `handleSecretarySelection(this, ${index})`);
                }
            });
        }

        function updateSubscriberNumbers() {
            const container = document.getElementById('subscribersContainer');
            const subscribers = container.querySelectorAll('.dynamic-section');
            
            subscribers.forEach((subscriber, index) => {
                const newNumber = index + 1;
                const h4 = subscriber.querySelector('h4');
                if (h4) {
                    h4.textContent = `Subscriber ${newNumber}`;
                }
            });
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showLoading(show) {
            const loadingSpinner = document.getElementById('loadingSpinner');
            if (show) {
                loadingSpinner.classList.add('active');
            } else {
                loadingSpinner.classList.remove('active');
            }
        }

        // Add fade out animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeOut {
                from {
                    opacity: 1;
                    transform: scale(1);
                }
                to {
                    opacity: 0;
                    transform: scale(0.9);
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>